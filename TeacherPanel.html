<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSentry - Teacher Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar { background: linear-gradient(135deg, #1e293b, #334155); }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
    </head>
<body class="antialiased text-gray-800">
    <div class="flex h-screen">
        <div class="sidebar w-64 p-6 text-white">
            <div class="mb-8">
                <h1 class="text-2xl font-bold"><span class="text-red-400">Edu</span>Sentry</h1>
                <p class="text-gray-300 text-sm">Teacher Panel</p>
            </div>
            <nav class="space-y-2">
                <a href="#dashboard" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition bg-gray-700">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    </svg>
                    Dashboard
                </a>
                <a href="#classrooms" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    Classrooms
                </a>
                <a href="#monitoring" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Monitoring
                </a>
                <a href="#students" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    Students
                </a>
                <a href="#alerts" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4.828 7l2.586 2.586a2 2 0 002.828 0L12.828 7H4.828z"></path>
                    </svg>
                    Alerts
                </a>
                <a href="#profile" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition" data-section="profile">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    My Profile
                </a>
            </nav>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="page-title" class="text-2xl font-bold text-gray-800">Students</h2>
                        <p id="page-subtitle" class="text-gray-600">Welcome, <span id="user-name">{{ user_name or 'Teacher' }}</span></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-200 transition">Main Dashboard</a>
                        <a href="/logout" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 transition">Logout</a>
                    </div>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Students</p>
                                    <p id="total-students" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Active Classrooms</p>
                                    <p id="active-classrooms" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Monitoring Sessions</p>
                                    <p id="monitoring-sessions" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-red-100 text-red-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Active Alerts</p>
                                    <p id="active-alerts" class="text-2xl font-bold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                        <div id="recent-activity" class="space-y-3">
                            <p class="text-gray-500">Loading activity...</p>
                        </div>
                    </div>
                </div>

                <!-- Classrooms Section -->
                <div id="classrooms-section" class="section hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Classrooms</h3>
                            <button id="create-classroom-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                Create Classroom
                            </button>
                        </div>
                        
                        <!-- Create Classroom Form (hidden by default) -->
                        <div id="create-classroom-form-container" class="hidden mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Create New Classroom</h4>
                                <form id="create-classroom-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Classroom Name *</label>
                                        <input type="text" name="classroomName" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Enter classroom name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <textarea name="description" rows="3"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                  placeholder="Enter classroom description (optional)"></textarea>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                            Create Classroom
                                        </button>
                                        <button type="button" id="cancel-create-classroom" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div id="classrooms-list" class="space-y-4">
                            <p class="text-gray-500">Loading classrooms...</p>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Section -->
                <div id="monitoring-section" class="section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Start Monitoring</h3>
                            <form id="start-monitoring-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Classroom</label>
                                    <select id="monitoring-classroom" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select a classroom</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Session Name</label>
                                    <input type="text" id="session-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter session name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Session Type</label>
                                    <select id="session-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Class">Class</option>
                                        <option value="Exam">Exam</option>
                                        <option value="Quiz">Quiz</option>
                                        <option value="Assignment">Assignment</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                                    Start Monitoring
                                </button>
                            </form>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Active Sessions</h3>
                            <div id="active-sessions-list" class="space-y-3">
                                <p class="text-gray-500">No active sessions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Section -->
                <div id="students-section" class="section hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Students</h3>
                            <button id="create-student-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                ‚ûï Add Student
                            </button>
                        </div>
                        
                        <!-- Create Student Form (hidden by default) -->
                        <div id="create-student-form-container" class="hidden mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Create New Student</h4>
                                <form id="create-student-form" class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                            <input type="text" name="firstName" required 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="First name">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                            <input type="text" name="lastName" required 
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Last name">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                        <input type="email" name="email" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="student@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
                                        <input type="text" name="studentId" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                                               placeholder="Auto-generated (STU01, STU02, ...)" 
                                               readonly 
                                               disabled>
                                        <p class="text-xs text-gray-500 mt-1">Student ID will be automatically generated (STU01, STU02, ...)</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                        <input type="password" name="password" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Minimum 6 characters">
                                    </div>
                                    <div class="flex space-x-3">
                                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                            Create Student
                                        </button>
                                        <button type="button" id="cancel-create-student" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="section hidden">
                    <div class="max-w-3xl mx-auto">
                        <div class="card p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">My Profile</h3>
                            
                            <!-- Avatar Section -->
                            <div class="flex items-center space-x-6 mb-6 pb-6 border-b border-gray-200">
                                <div class="relative">
                                    <img id="teacher-profile-avatar" src="" alt="Avatar" 
                                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 hidden"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ddd\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'40\'%3Eüë§%3C/text%3E%3C/svg%3E';">
                                    <div id="teacher-profile-avatar-placeholder" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center border-4 border-gray-200">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Profile Picture</p>
                                    <p class="text-xs text-gray-500">Avatar is taken from your registered face</p>
                                    <p class="text-xs text-gray-400 mt-1">Register your face to set your avatar</p>
                                </div>
                            </div>
                            
                            <form id="teacher-profile-form" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                        <input type="text" name="firstName" id="teacher-profile-firstName" required 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="First name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                        <input type="text" name="lastName" id="teacher-profile-lastName" required 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Last name">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" name="email" id="teacher-profile-email" required 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="your.email@example.com">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <input type="text" id="teacher-profile-role" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" 
                                           readonly 
                                           disabled>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <input type="checkbox" id="teacher-profile-change-password" class="mr-2"> Change Password
                                    </label>
                                    <input type="password" name="password" id="teacher-profile-password" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 hidden" 
                                           placeholder="Enter new password (minimum 6 characters)">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty to keep current password</p>
                                </div>
                                
                                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                    <button type="button" id="teacher-cancel-profile" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                        Cancel
                                    </button>
                                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                            
                            <div id="teacher-profile-message" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div id="alerts-section" class="section hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Recent Alerts</h3>
                        </div>
                        <div id="alerts-list" class="space-y-3"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const API_BASE_URL = `${window.location.origin}/api`;

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    navItems.forEach(n => n.classList.remove('bg-gray-700'));
                    item.classList.add('bg-gray-700');
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = item.getAttribute('href').substring(1);
                    document.getElementById(target + '-section').classList.remove('hidden');
                    
                    // Load data based on section
                    if (target === 'dashboard') loadDashboard();
                    if (target === 'classrooms') loadClassrooms();
                    if (target === 'monitoring') loadMonitoring();
                    if (target === 'students') loadStudents();
                    if (target === 'alerts') loadAlerts();
                    if (target === 'profile') loadTeacherProfileData();
                });
            });
        }

        async function loadDashboard() {
            try {
                // Load all data in parallel for faster loading
                const [studentsRes, classroomsRes, sessionsRes, alertsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/teacher/students`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/teacher/classrooms`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/teacher/monitoring/sessions`, { credentials: 'include' }),
                    fetch(`${API_BASE_URL}/teacher/alerts`, { credentials: 'include' })
                ]);

                // Parse all responses in parallel
                const [studentsData, classroomsData, sessionsData, alertsData] = await Promise.all([
                    studentsRes.json(),
                    classroomsRes.json(),
                    sessionsRes.json(),
                    alertsRes.json()
                ]);

                // Update UI
                if (studentsRes.ok) {
                    document.getElementById('total-students').textContent = studentsData.users?.length || 0;
                }

                if (classroomsRes.ok) {
                    document.getElementById('active-classrooms').textContent = classroomsData.classrooms?.length || 0;
                }

                if (sessionsRes.ok) {
                    document.getElementById('monitoring-sessions').textContent = sessionsData.sessions?.length || 0;
                }

                if (alertsRes.ok) {
                    document.getElementById('active-alerts').textContent = alertsData.alerts?.length || 0;
                }

                // Load recent activity
                loadRecentActivity();
            } catch (e) {
                console.error('Error loading dashboard:', e);
            }
        }

        async function loadRecentActivity() {
            const container = document.getElementById('recent-activity');
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                        <div class="text-sm text-gray-700">System initialized successfully</div>
                        <div class="text-xs text-gray-500 ml-auto">Just now</div>
                    </div>
                    <div class="flex items-center p-3 bg-green-50 rounded-lg">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <div class="text-sm text-gray-700">Teacher panel loaded</div>
                        <div class="text-xs text-gray-500 ml-auto">Just now</div>
                    </div>
                </div>
            `;
        }

        async function loadClassrooms() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/classrooms`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to load classrooms');
                
                const container = document.getElementById('classrooms-list');
                if (!data.classrooms.length) {
                    container.innerHTML = '<p class="text-gray-500">No classrooms found. Create your first classroom!</p>';
                    return;
                }
                
                container.innerHTML = data.classrooms.map(c => `
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-800">${c.classroomName}</h4>
                                <p class="text-sm text-gray-600">${c.description || 'No description'}</p>
                                <p class="text-xs text-gray-500 mt-1">Created: ${new Date(c.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2 flex-wrap gap-2">
                                <button onclick="uploadExamPaper('${c.classroomId}', '${c.classroomName}')" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200">
                                    üìÑ Upload ƒê·ªÅ
                                </button>
                                <button onclick="viewExamSubmissions('${c.classroomId}', '${c.classroomName}')" class="bg-purple-100 text-purple-700 px-3 py-1 rounded text-sm hover:bg-purple-200">
                                    üì• Xem b√†i n·ªôp
                                </button>
                                <button onclick="manageClassroomStudents('${c.classroomId}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200">
                                    Manage Students
                                </button>
                                <button onclick="editClassroom('${c.classroomId}', '${encodeURIComponent(c.classroomName)}', '${encodeURIComponent(c.description || '')}', ${c.isActive ? true : false})" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm hover:bg-yellow-200">
                                    Edit
                                </button>
                                <button onclick="deleteClassroom('${c.classroomId}')" class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading classrooms:', e);
                document.getElementById('classrooms-list').innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <p class="text-red-700">Error loading classrooms: ${e.message}</p>
                        </div>
                        <button onclick="loadClassrooms()" class="mt-2 text-sm text-red-600 hover:text-red-800 underline">Try again</button>
                    </div>
                `;
            }
        }

        async function loadMonitoring() {
            try {
                // Load classrooms for monitoring
                const classroomsRes = await fetch(`${API_BASE_URL}/teacher/classrooms`, { credentials: 'include' });
                const classroomsData = await classroomsRes.json();
                if (classroomsRes.ok) {
                    const select = document.getElementById('monitoring-classroom');
                    select.innerHTML = '<option value="">Select a classroom</option>';
                    classroomsData.classrooms.forEach(c => {
                        select.innerHTML += `<option value="${c.classroomId}">${c.classroomName}</option>`;
                    });
                    
                    // Auto-select if only one classroom available
                    if (classroomsData.classrooms.length === 1) {
                        select.value = classroomsData.classrooms[0].classroomId;
                        // Auto-fill session name with default
                        const sessionNameInput = document.getElementById('session-name');
                        if (sessionNameInput && !sessionNameInput.value) {
                            sessionNameInput.value = `Session ${new Date().toLocaleDateString('vi-VN')}`;
                        }
                    }
                }

                // Load active sessions
                const sessionsRes = await fetch(`${API_BASE_URL}/teacher/monitoring/sessions`, { credentials: 'include' });
                const sessionsData = await sessionsRes.json();
                if (sessionsRes.ok) {
                    const container = document.getElementById('active-sessions-list');
                    if (!sessionsData.sessions.length) {
                        container.innerHTML = '<p class="text-gray-500">No active monitoring sessions</p>';
                        return;
                    }
                    
                    container.innerHTML = sessionsData.sessions.map(s => `
                        <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold text-gray-800">${s.sessionName}</h4>
                                    <p class="text-sm text-gray-600">${s.sessionType} ‚Ä¢ ${s.studentCount} students</p>
                                    <p class="text-xs text-gray-500">Started: ${new Date(s.startTime).toLocaleString()}</p>
                                </div>
                                <button onclick="stopMonitoring('${s.sessionId}')" class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200">
                                    Stop
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading monitoring:', e);
            }
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/students`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to load students');
                const tbody = document.getElementById('students-table-body');
                
                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">No students found. Create your first student!</td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = data.users.map(u => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${u.firstName} ${u.lastName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">${u.studentId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${u.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${u.roleName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="editStudent('${u.userId}', '${u.firstName.replace(/'/g, "\\'")}', '${u.lastName.replace(/'/g, "\\'")}', '${u.email.replace(/'/g, "\\'")}', '${(u.studentId || '').replace(/'/g, "\\'")}')" 
                                    class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 mr-2">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteStudent('${u.userId}', '${u.firstName.replace(/'/g, "\\'")} ${u.lastName.replace(/'/g, "\\'")}')" 
                                    class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading students:', e);
                const tbody = document.getElementById('students-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading students: ${e.message}</td>
                    </tr>
                `;
            }
        }
        
        // Create student
        document.getElementById('create-student-btn').addEventListener('click', () => {
            document.getElementById('create-student-form-container').classList.remove('hidden');
        });
        
        document.getElementById('cancel-create-student').addEventListener('click', () => {
            document.getElementById('create-student-form-container').classList.add('hidden');
            document.getElementById('create-student-form').reset();
        });
        
        document.getElementById('create-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        email: formData.get('email'),
                        password: formData.get('password')
                        // Student ID is auto-generated, don't send it
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to create student');
                
                form.reset();
                document.getElementById('create-student-form-container').classList.add('hidden');
                loadStudents();
                alert('Student created successfully!');
            } catch (e) {
                console.error('Error creating student:', e);
                alert('Error creating student: ' + e.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Edit student
        window.editStudent = function(userId, firstName, lastName, email, studentId) {
            // Show current Student ID (read-only)
            alert(`Student ID: ${studentId || 'N/A'}\n\nNote: Student ID cannot be changed.`);
            
            const newFirstName = prompt('First Name:', firstName);
            if (newFirstName === null) return;
            
            const newLastName = prompt('Last Name:', lastName);
            if (newLastName === null) return;
            
            const newEmail = prompt('Email:', email);
            if (newEmail === null) return;
            
            const changePassword = confirm('Do you want to change the password?');
            let newPassword = '';
            if (changePassword) {
                newPassword = prompt('New Password (minimum 6 characters):');
                if (newPassword === null) return;
                if (newPassword.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }
            }
            
            const updateData = {
                firstName: newFirstName,
                lastName: newLastName,
                email: newEmail
                // Student ID is read-only, don't send it
            };
            
            if (newPassword) {
                updateData.password = newPassword;
            }
            
            fetch(`${API_BASE_URL}/teacher/students/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(updateData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    loadStudents();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(e => {
                console.error('Error updating student:', e);
                alert('Error updating student: ' + e.message);
            });
        };
        
        // Delete student
        window.deleteStudent = function(userId, studentName) {
            if (!confirm(`Are you sure you want to delete student "${studentName}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            fetch(`${API_BASE_URL}/teacher/students/${userId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    loadStudents();
                } else {
                    alert('Error: ' + (data.error || data.message || 'Unknown error'));
                }
            })
            .catch(e => {
                console.error('Error deleting student:', e);
                alert('Error deleting student: ' + e.message);
            });
        };

        async function loadAlerts() {
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/alerts`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to load alerts');
                const container = document.getElementById('alerts-list');
                if (!data.alerts.length) { 
                    container.innerHTML = '<p class="text-gray-500">No alerts</p>'; 
                    return; 
                }
                container.innerHTML = data.alerts.map(a => `
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium">${a.type}</span>
                            <span class="text-xs ${a.severity==='high'?'text-red-600':'text-yellow-600'}">${a.severity}</span>
                        </div>
                        <div class="text-xs text-gray-500">${new Date(a.timestamp).toLocaleString()}</div>
                        <div class="text-sm text-gray-700">${a.description || ''}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading alerts:', e);
            }
        }

        // Create classroom
        document.getElementById('create-classroom-btn').addEventListener('click', () => {
            const name = prompt('Enter classroom name:');
            if (!name) return;
            
            const description = prompt('Enter classroom description (optional):');
            
            fetch(`${API_BASE_URL}/teacher/classrooms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ classroomName: name, description: description || '' })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    loadClassrooms();
                }
            })
            .catch(e => console.error('Error creating classroom:', e));
        });

        // Start monitoring
        document.getElementById('start-monitoring-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const classroomId = document.getElementById('monitoring-classroom').value;
            const sessionName = document.getElementById('session-name').value;
            const sessionType = document.getElementById('session-type').value;
            
            if (!classroomId || !sessionName) {
                alert('Please fill in all required fields');
                return;
            }
            
            fetch(`${API_BASE_URL}/teacher/monitoring/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ 
                    classroomId: classroomId, 
                    sessionName: sessionName, 
                    sessionType: sessionType 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.message && data.classroomId) {
                    // Redirect to monitoring page for the classroom
                    window.location.href = `/monitoring/${data.classroomId}`;
                } else if (data.message) {
                    alert(data.message);
                    loadMonitoring();
                }
            })
            .catch(e => console.error('Error starting monitoring:', e));
        });

        // Stop monitoring
        window.stopMonitoring = function(sessionId) {
            if (confirm('Are you sure you want to stop this monitoring session?')) {
                fetch(`${API_BASE_URL}/teacher/monitoring/stop/${sessionId}`, {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        loadMonitoring();
                    }
                })
                .catch(e => console.error('Error stopping monitoring:', e));
            }
        };

        // Edit classroom
        window.editClassroom = async function(classroomId, encodedName, encodedDescription, isActive) {
            try {
                const currentName = decodeURIComponent(encodedName || '');
                const currentDescription = decodeURIComponent(encodedDescription || '');
                const currentActive = Boolean(isActive);
                
                const name = prompt('Update classroom name:', currentName);
                if (name === null) return;
                if (!name.trim()) {
                    alert('Classroom name cannot be empty');
                    return;
                }
                
                const description = prompt('Update classroom description (optional):', currentDescription);
                if (description === null) return;
                
                const toggleActive = confirm(currentActive
                    ? 'L·ªõp h·ªçc ƒëang ho·∫°t ƒë·ªông. Nh·∫•n OK ƒë·ªÉ gi·ªØ tr·∫°ng th√°i ho·∫°t ƒë·ªông, Cancel ƒë·ªÉ chuy·ªÉn sang t·∫°m d·ª´ng.'
                    : 'L·ªõp h·ªçc ƒëang t·∫°m d·ª´ng. Nh·∫•n OK ƒë·ªÉ k√≠ch ho·∫°t l·∫°i, Cancel ƒë·ªÉ ti·∫øp t·ª•c t·∫°m d·ª´ng.');
                
                const response = await fetch(`${API_BASE_URL}/teacher/classrooms/${classroomId}`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        classroomName: name.trim(),
                        description: (description ?? '').trim(),
                        isActive: toggleActive
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Classroom updated successfully!');
                    loadClassrooms();
                } else {
                    alert('Failed to update classroom: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating classroom:', error);
                alert('Error updating classroom: ' + error.message);
            }
        };

        // Manage classroom students
        window.manageClassroomStudents = function(classroomId) {
            window.location.href = `/teacher/classrooms/${classroomId}/students`;
        };

        // Delete classroom
        window.deleteClassroom = async function(classroomId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp h·ªçc n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† s·∫Ω x√≥a t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan (ƒë·ªÅ thi, b√†i n·ªôp, h·ªçc sinh, v.v.).')) {
                return;
            }
            
            // Confirm again
            if (!confirm('C·∫£nh b√°o: T·∫•t c·∫£ d·ªØ li·ªáu c·ªßa l·ªõp h·ªçc n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/teacher/classrooms/${classroomId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('ƒê√£ x√≥a l·ªõp h·ªçc th√†nh c√¥ng!');
                    loadClassrooms(); // Reload the list
                } else {
                    alert('L·ªói khi x√≥a l·ªõp h·ªçc: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting classroom:', error);
                alert('L·ªói khi x√≥a l·ªõp h·ªçc: ' + error.message);
            }
        };

        // Classroom management
        document.getElementById('create-classroom-btn').addEventListener('click', () => {
            document.getElementById('create-classroom-form-container').classList.remove('hidden');
        });

        document.getElementById('cancel-create-classroom').addEventListener('click', () => {
            document.getElementById('create-classroom-form-container').classList.add('hidden');
            document.getElementById('create-classroom-form').reset();
        });

        // Create classroom form
        document.getElementById('create-classroom-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_BASE_URL}/teacher/classrooms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        classroomName: formData.get('classroomName'),
                        description: formData.get('description')
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to create classroom');
                
                form.reset();
                document.getElementById('create-classroom-form-container').classList.add('hidden');
                loadClassrooms();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'mt-4 p-3 bg-green-50 border border-green-200 rounded-lg';
                successMsg.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <p class="text-green-700">Classroom "${data.classroom.classroomName}" created successfully!</p>
                    </div>
                `;
                document.getElementById('classrooms-list').parentNode.insertBefore(successMsg, document.getElementById('classrooms-list'));
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);
                
            } catch (e) {
                console.error('Error creating classroom:', e);
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'mt-4 p-3 bg-red-50 border border-red-200 rounded-lg';
                errorMsg.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p class="text-red-700">Failed to create classroom: ${e.message}</p>
                    </div>
                `;
                document.getElementById('classrooms-list').parentNode.insertBefore(errorMsg, document.getElementById('classrooms-list'));
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorMsg.parentNode) {
                        errorMsg.parentNode.removeChild(errorMsg);
                    }
                }, 5000);
                
            } finally {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Upload exam paper modal
        window.uploadExamPaper = function(classroomId, classroomName) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'upload-exam-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">T·∫£i ƒë·ªÅ thi l√™n l·ªõp h·ªçc</h3>
                        <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">L·ªõp h·ªçc: <strong>${classroomName}</strong></p>
                    <form id="upload-exam-form" enctype="multipart/form-data">
                        <input type="hidden" name="classroomId" value="${classroomId}">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒë·ªÅ thi *</label>
                            <input type="text" name="paperName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="V√≠ d·ª•: ƒê·ªÅ thi gi·ªØa k·ª≥ - M√¥n To√°n">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn file ƒë·ªÅ thi *</label>
                            <input type="file" name="examFile" accept=".pdf,.doc,.docx" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onchange="validateFileSize(this)">
                            <p class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file PDF, DOC, DOCX (t·ªëi ƒëa 10MB)</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Th·ªùi gian l√†m b√†i (ph√∫t)</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="setDuration(15)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">15 ph√∫t</button>
                                <button type="button" onclick="setDuration(30)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">30 ph√∫t</button>
                                <button type="button" onclick="setDuration(60)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">60 ph√∫t</button>
                                <button type="button" onclick="setDuration(90)" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">90 ph√∫t</button>
                            </div>
                            <input type="number" name="duration" min="1" step="1"
                                   class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Nh·∫≠p s·ªë ph√∫t (ƒë·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n)">
                            <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n th·ªùi gian</p>
                        </div>
                        <div class="flex space-x-3">
                            <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                T·∫£i l√™n
                            </button>
                            <button type="button" onclick="closeUploadModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                H·ªßy
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('upload-exam-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                submitBtn.textContent = 'ƒêang t·∫£i l√™n...';
                submitBtn.disabled = true;
                
                try {
                    const res = await fetch(`${API_BASE_URL}/teacher/classrooms/${classroomId}/upload-exam`, {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Failed to upload exam paper');
                    
                    alert('T·∫£i ƒë·ªÅ thi l√™n th√†nh c√¥ng!');
                    closeUploadModal();
                    loadClassrooms();
                } catch (error) {
                    console.error('Error uploading exam paper:', error);
                    alert('L·ªói khi t·∫£i ƒë·ªÅ thi: ' + error.message);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        };

        window.closeUploadModal = function() {
            const modal = document.getElementById('upload-exam-modal');
            if (modal) {
                modal.remove();
            }
        };

        function validateFileSize(input) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (input.files[0] && input.files[0].size > maxSize) {
                alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 10MB.');
                input.value = '';
            }
        }

        function setDuration(minutes) {
            const durationInput = document.querySelector('input[name="duration"]');
            if (durationInput) {
                durationInput.value = minutes;
            }
        }

        // View exam submissions
        window.viewExamSubmissions = async function(classroomId, classroomName) {
            try {
                const papersRes = await fetch(`/api/classroom/${classroomId}/exam-papers`, {
                    credentials: 'include'
                });
                
                if (!papersRes.ok) {
                    throw new Error('Failed to load exam papers');
                }
                
                const papersData = await papersRes.json();
                
                if (!papersData.examPapers || papersData.examPapers.length === 0) {
                    alert('L·ªõp h·ªçc n√†y ch∆∞a c√≥ ƒë·ªÅ thi n√†o.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.id = 'submissions-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">B√†i n·ªôp - ${classroomName}</h3>
                            <button onclick="closeSubmissionsModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="submissions-content">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn ƒë·ªÅ thi:</label>
                                <select id="submission-paper-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadPaperSubmissions(this.value)">
                                    <option value="">-- Ch·ªçn ƒë·ªÅ thi --</option>
                                    ${papersData.examPapers.map(paper => `
                                        <option value="${paper.paperId}">${paper.paperName}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div id="submissions-list" class="mt-4">
                                <p class="text-gray-500 text-center py-4">Vui l√≤ng ch·ªçn ƒë·ªÅ thi ƒë·ªÉ xem danh s√°ch b√†i n·ªôp</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                alert('L·ªói khi t·∫£i danh s√°ch b√†i n·ªôp: ' + error.message);
            }
        };

        window.closeSubmissionsModal = function() {
            const modal = document.getElementById('submissions-modal');
            if (modal) modal.remove();
        };

        window.loadPaperSubmissions = async function(paperId) {
            if (!paperId) return;
            
            const listContainer = document.getElementById('submissions-list');
            listContainer.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
            
            try {
                const res = await fetch(`/api/exam/teacher/submissions/${paperId}`, {
                    credentials: 'include'
                });
                
                if (!res.ok) throw new Error('Failed to load submissions');
                
                const data = await res.json();
                
                if (data.submissions.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ h·ªçc sinh n√†o n·ªôp b√†i.</p>';
                    return;
                }
                
                listContainer.innerHTML = `
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">T·ªïng s·ªë b√†i n·ªôp: <strong>${data.total_submissions}</strong></p>
                    </div>
                    <div class="space-y-3">
                        ${data.submissions.map((sub, index) => {
                            const submittedDate = sub.submitted_at ? new Date(sub.submitted_at).toLocaleString('vi-VN') : '';
                            // Escape quotes and special characters for JavaScript
                            const safeUserId = String(sub.user_id).replace(/'/g, "\\'").replace(/"/g, '\\"');
                            const safePaperId = String(paperId).replace(/'/g, "\\'").replace(/"/g, '\\"');
                            const safeStudentName = String(sub.student_name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
                            
                            // Format score display
                            let scoreDisplay = '';
                            if (sub.total_score !== null && sub.total_score !== undefined) {
                                if (sub.max_total_score) {
                                    scoreDisplay = `<span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold ml-2">${sub.total_score.toFixed(1)}/${sub.max_total_score.toFixed(1)}${sub.percentage ? ` (${sub.percentage.toFixed(1)}%)` : ''}</span>`;
                                } else {
                                    scoreDisplay = `<span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold ml-2">${sub.total_score.toFixed(1)} ƒëi·ªÉm</span>`;
                                }
                            } else {
                                scoreDisplay = '<span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm ml-2">Ch∆∞a ch·∫•m</span>';
                            }
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-1">
                                                <h4 class="font-semibold text-gray-800">${sub.student_name}</h4>
                                                ${scoreDisplay}
                                            </div>
                                            <p class="text-sm text-gray-600">${sub.student_email}</p>
                                            <p class="text-xs text-gray-500 mt-1">N·ªôp l√∫c: ${submittedDate}</p>
                                        </div>
                                        <button onclick="viewStudentSubmission('${safePaperId}', '${safeUserId}', '${safeStudentName}')" 
                                                class="bg-blue-100 text-blue-700 px-4 py-2 rounded text-sm hover:bg-blue-200 ml-4">
                                            Xem chi ti·∫øt
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading paper submissions:', error);
                listContainer.innerHTML = `<p class="text-red-500 text-center py-4">L·ªói: ${error.message}</p>`;
            }
        };

        window.viewStudentSubmission = async function(paperId, userId, studentName) {
            try {
                // Encode IDs for URL safety
                const encodedPaperId = encodeURIComponent(paperId);
                const encodedUserId = encodeURIComponent(userId);
                
                console.log('Loading submission for:', { paperId, userId, studentName });
                
                // Load questions, submission, and grades in parallel
                const [questionsRes, submissionRes, gradesRes] = await Promise.all([
                    fetch(`/api/exam/parse/${encodedPaperId}`, { credentials: 'include' }),
                    fetch(`/api/exam/teacher/submission/${encodedPaperId}/${encodedUserId}`, { credentials: 'include' }),
                    fetch(`/api/exam/teacher/grades/${encodedPaperId}/${encodedUserId}`, { credentials: 'include' })
                ]);
                
                if (!submissionRes.ok) {
                    const errorData = await submissionRes.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Submission response error:', errorData);
                    throw new Error(errorData.error || `Failed to load submission: ${submissionRes.status}`);
                }
                
                if (!questionsRes.ok) {
                    console.warn('Failed to load questions, continuing anyway');
                }
                
                const submissionData = await submissionRes.json();
                const questionsData = questionsRes.ok ? await questionsRes.json() : { questions: [] };
                const gradesData = gradesRes.ok ? await gradesRes.json() : { grades: {}, total_score: null };
                
                console.log('Loaded submission data:', submissionData);
                console.log('Loaded grades data:', gradesData);
                
                const modal = document.createElement('div');
                modal.id = 'submission-detail-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">B√†i l√†m c·ªßa ${studentName}</h3>
                            <button onclick="closeSubmissionDetailModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="text-sm text-green-700">
                                    <strong>Tr·∫°ng th√°i:</strong> ƒê√£ n·ªôp 
                                    ${submissionData.submission.submitted_at ? 
                                        `- ${new Date(submissionData.submission.submitted_at).toLocaleString('vi-VN')}` : ''}
                                </p>
                            </div>
                            <div id="total-score-display" class="text-lg font-bold text-green-700">
                                ${gradesData.total_score !== null ? 
                                    `T·ªïng ƒëi·ªÉm: ${gradesData.total_score}${gradesData.max_total_score ? ` / ${gradesData.max_total_score}` : ''}${gradesData.percentage ? ` (${gradesData.percentage.toFixed(1)}%)` : ''}` : 
                                    'Ch∆∞a ch·∫•m ƒëi·ªÉm'}
                            </div>
                        </div>
                        <form id="grading-form-${paperId}-${userId}" onsubmit="return false;">
                            <div id="submission-answers" class="space-y-4">
                                ${questionsData.questions.map(q => {
                                    const questionNum = q.question_number || 1;
                                    const answer = submissionData.answers[String(questionNum)];
                                    const grade = gradesData.grades[String(questionNum)] || { score: '', max_score: '', feedback: '' };
                                    
                                    let answerDisplay = '';
                                    
                                    if (q.type === 'multiple_choice') {
                                        answerDisplay = Array.isArray(answer) ? 
                                            `<p class="text-gray-700">ƒê√£ ch·ªçn: <strong>${answer.join(', ')}</strong></p>` : 
                                            '<p class="text-gray-500 italic">Ch∆∞a tr·∫£ l·ªùi</p>';
                                    } else {
                                        answerDisplay = answer ? 
                                            `<p class="text-gray-700 whitespace-pre-wrap">${answer}</p>` : 
                                            '<p class="text-gray-500 italic">Ch∆∞a tr·∫£ l·ªùi</p>';
                                    }
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-start mb-3">
                                                <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">${questionNum}</span>
                                                <div class="flex-1">
                                                    <p class="text-gray-800 mb-2">${q.content}</p>
                                                    <div class="mt-3 p-3 bg-gray-50 rounded border mb-3">
                                                        <p class="text-xs text-gray-500 mb-1">C√¢u tr·∫£ l·ªùi:</p>
                                                        ${answerDisplay}
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-4 items-end">
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">ƒêi·ªÉm</label>
                                                            <input type="number" step="0.1" min="0" 
                                                                   class="grade-score w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                                                   name="score_${questionNum}" 
                                                                   value="${grade.score || ''}" 
                                                                   placeholder="0"
                                                                   onchange="updateTotalScore('${paperId}', '${userId}')">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">ƒêi·ªÉm t·ªëi ƒëa</label>
                                                            <input type="number" step="0.1" min="0" 
                                                                   class="grade-max-score w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                                                   name="max_score_${questionNum}" 
                                                                   value="${grade.max_score || ''}" 
                                                                   placeholder="0"
                                                                   onchange="updateTotalScore('${paperId}', '${userId}')">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-gray-700 mb-1">Nh·∫≠n x√©t</label>
                                                            <input type="text" 
                                                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                                                   name="feedback_${questionNum}" 
                                                                   value="${(grade.feedback || '').replace(/"/g, '&quot;')}" 
                                                                   placeholder="Nh·∫≠n x√©t...">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                <div class="text-lg font-semibold">
                                    T·ªïng ƒëi·ªÉm: <span id="calculated-total-${paperId}-${userId}" class="text-blue-600">0</span>
                                </div>
                                <button type="button" 
                                        onclick="saveGrades('${paperId}', '${userId}')" 
                                        class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition">
                                    üíæ L∆∞u ƒëi·ªÉm
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Initialize total score display
                updateTotalScore(paperId, userId);
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing submission:', error);
                console.error('Error details:', {
                    paperId: paperId,
                    userId: userId,
                    error: error.message,
                    stack: error.stack
                });
                alert('L·ªói khi xem b√†i l√†m: ' + (error.message || 'Unknown error'));
            }
        };

        window.closeSubmissionDetailModal = function() {
            const modal = document.getElementById('submission-detail-modal');
            if (modal) modal.remove();
        };

        // Calculate and update total score
        function updateTotalScore(paperId, userId) {
            const form = document.getElementById(`grading-form-${paperId}-${userId}`);
            if (!form) return;
            
            let total = 0;
            const scoreInputs = form.querySelectorAll('.grade-score');
            scoreInputs.forEach(input => {
                const score = parseFloat(input.value) || 0;
                total += score;
            });
            
            const totalDisplay = document.getElementById(`calculated-total-${paperId}-${userId}`);
            if (totalDisplay) {
                totalDisplay.textContent = total.toFixed(1);
            }
        }

        // Save grades
        async function saveGrades(paperId, userId) {
            const form = document.getElementById(`grading-form-${paperId}-${userId}`);
            if (!form) return;
            
            const grades = {};
            let totalScore = 0;
            
            // Collect all grades
            const questionNumbers = new Set();
            form.querySelectorAll('[name^="score_"]').forEach(input => {
                const questionNum = input.name.replace('score_', '');
                questionNumbers.add(questionNum);
            });
            
            questionNumbers.forEach(qNum => {
                const scoreInput = form.querySelector(`[name="score_${qNum}"]`);
                const maxScoreInput = form.querySelector(`[name="max_score_${qNum}"]`);
                const feedbackInput = form.querySelector(`[name="feedback_${qNum}"]`);
                
                const score = parseFloat(scoreInput.value) || 0;
                const maxScore = maxScoreInput.value ? parseFloat(maxScoreInput.value) : null;
                const feedback = feedbackInput.value.trim() || '';
                
                grades[qNum] = {
                    score: score,
                    max_score: maxScore,
                    feedback: feedback
                };
                
                totalScore += score;
            });
            
            try {
                const response = await fetch(`/api/exam/teacher/grade/${encodeURIComponent(paperId)}/${encodeURIComponent(userId)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        grades: grades,
                        total_score: totalScore
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert('ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng!');
                    
                    // Update total score display in modal
                    const totalDisplay = document.getElementById('total-score-display');
                    if (totalDisplay) {
                        totalDisplay.innerHTML = `T·ªïng ƒëi·ªÉm: <span class="text-lg font-bold">${totalScore.toFixed(1)}</span>`;
                    }
                    
                    // Reload submissions list to update score display
                    const paperSelect = document.getElementById('submission-paper-select');
                    if (paperSelect && paperSelect.value) {
                        loadPaperSubmissions(paperSelect.value);
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    alert('L·ªói khi l∆∞u ƒëi·ªÉm: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving grades:', error);
                alert('L·ªói khi l∆∞u ƒëi·ªÉm. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Load teacher profile data
        async function loadTeacherProfileData() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok && data.user) {
                    const user = data.user;
                    
                    // Populate form
                    document.getElementById('teacher-profile-firstName').value = user.firstName || '';
                    document.getElementById('teacher-profile-lastName').value = user.lastName || '';
                    document.getElementById('teacher-profile-email').value = user.email || '';
                    document.getElementById('teacher-profile-role').value = user.roleName || 'Unassigned';
                    
                    // Set avatar
                    const avatarImg = document.getElementById('teacher-profile-avatar');
                    const avatarPlaceholder = document.getElementById('teacher-profile-avatar-placeholder');
                    if (user.avatar) {
                        // If avatar is base64, add data URL prefix if needed
                        let avatarSrc = user.avatar;
                        if (!avatarSrc.startsWith('data:image')) {
                            // Assume it's base64 encoded image, add prefix
                            avatarSrc = 'data:image/jpeg;base64,' + avatarSrc;
                        }
                        avatarImg.src = avatarSrc;
                        avatarImg.classList.remove('hidden');
                        avatarPlaceholder.classList.add('hidden');
                    } else {
                        avatarImg.classList.add('hidden');
                        avatarPlaceholder.classList.remove('hidden');
                    }
                    
                    // Reset password field
                    document.getElementById('teacher-profile-change-password').checked = false;
                    document.getElementById('teacher-profile-password').classList.add('hidden');
                    document.getElementById('teacher-profile-password').value = '';
                    document.getElementById('teacher-profile-password').required = false;
                    
                    // Hide message
                    document.getElementById('teacher-profile-message').classList.add('hidden');
                } else {
                    showTeacherProfileMessage('Error loading profile: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error('Error loading profile:', err);
                showTeacherProfileMessage('Error loading profile information', 'error');
            }
        }

        // Toggle password field
        document.getElementById('teacher-profile-change-password')?.addEventListener('change', (e) => {
            const passwordField = document.getElementById('teacher-profile-password');
            if (e.target.checked) {
                passwordField.classList.remove('hidden');
                passwordField.required = true;
            } else {
                passwordField.classList.add('hidden');
                passwordField.required = false;
                passwordField.value = '';
            }
        });

        // Handle teacher profile form submit
        document.getElementById('teacher-profile-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email')
            };
            
            // Only include password if change password is checked
            const changePassword = document.getElementById('teacher-profile-change-password').checked;
            if (changePassword) {
                const password = formData.get('password');
                if (password && password.length >= 6) {
                    profileData.password = password;
                } else if (password) {
                    showTeacherProfileMessage('Password must be at least 6 characters long', 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showTeacherProfileMessage('Profile updated successfully!', 'success');
                    // Update header name
                    const userNameSpan = document.getElementById('user-name');
                    if (userNameSpan) {
                        userNameSpan.textContent = `${profileData.firstName} ${profileData.lastName}`;
                    }
                    // Reload profile data
                    setTimeout(() => loadTeacherProfileData(), 1000);
                } else {
                    showTeacherProfileMessage('Error: ' + (data.message || 'Failed to update profile'), 'error');
                }
            } catch (err) {
                console.error('Error updating profile:', err);
                showTeacherProfileMessage('Error updating profile', 'error');
            }
        });

        // Cancel teacher profile changes
        document.getElementById('teacher-cancel-profile')?.addEventListener('click', () => {
            loadTeacherProfileData();
        });

        // Show teacher profile message
        function showTeacherProfileMessage(message, type) {
            const messageDiv = document.getElementById('teacher-profile-message');
            if (!messageDiv) return;
            
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                messageDiv.className = 'mt-4 p-4 bg-green-100 text-green-700 border border-green-400 rounded-lg';
            } else {
                messageDiv.className = 'mt-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg';
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            loadDashboard();
        });
    </script>
</body>
</html>


