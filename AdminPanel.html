<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSentry - Admin Panel</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .sidebar {
            background: linear-gradient(135deg, #1e293b, #334155);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        .admin-card {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <!-- Sidebar -->
    <div class="flex h-screen">
        <div class="sidebar w-64 p-6 text-white">
            <div class="mb-8">
                <h1 class="text-2xl font-bold">
                    <span class="text-red-400">Edu</span>Sentry
                </h1>
                <p class="text-gray-300 text-sm">Admin Panel</p>
            </div>
            
            <nav class="space-y-2">
                <a href="#dashboard" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition bg-gray-700">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                    </svg>
                    Dashboard
                </a>
                <a href="#users" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    User Management
                </a>
                <a href="#roles" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Role Management
                </a>
                <a href="#profile" class="nav-item flex items-center p-3 rounded-lg hover:bg-gray-700 transition" data-section="profile">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    My Profile
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 id="page-title" class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                        <p id="page-subtitle" class="text-gray-600">Welcome back, <span id="user-name">{{ user_name or 'Admin' }}</span> ({{ user_role or 'Admin' }})</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-200 transition">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            </svg>
                            Main Dashboard
                        </a>
                        <a href="/logout" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 transition">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="admin-card p-6 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">Total Users</p>
                                    <p id="total-users" class="text-3xl font-bold">0</p>
                                </div>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Teachers</p>
                                    <p id="total-teachers" class="text-3xl font-bold text-blue-600">0</p>
                                </div>
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Students</p>
                                    <p id="total-students" class="text-3xl font-bold text-green-600">0</p>
                                </div>
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Active Sessions</p>
                                    <p id="active-sessions" class="text-3xl font-bold text-purple-600">0</p>
                                </div>
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="users-section" class="section hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">User Management</h3>
                            <div class="flex items-center space-x-2">
                                <button data-filter="all" class="user-filter-btn px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200">All</button>
                                <button data-filter="teachers" class="user-filter-btn px-3 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-700 hover:bg-blue-200">Teachers</button>
                                <button data-filter="students" class="user-filter-btn px-3 py-2 rounded-lg text-sm font-semibold bg-green-100 text-green-700 hover:bg-green-200">Students</button>
                            </div>
                            <button id="add-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add User
                            </button>
                        </div>
                        
                        <div class="flex justify-center">
                            <div class="overflow-x-auto w-full max-w-6xl">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Role Management Section -->
                <div id="roles-section" class="section hidden">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Role Management</h3>
                            <button id="add-role-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Role
                            </button>
                        </div>
                        
                        <div class="flex justify-center">
                            <div class="overflow-x-auto w-full max-w-6xl">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Users</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="roles-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Roles will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="section hidden">
                    <div class="max-w-3xl mx-auto">
                        <div class="card p-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6">My Profile</h3>
                            
                            <!-- Avatar Section -->
                            <div class="flex items-center space-x-6 mb-6 pb-6 border-b border-gray-200">
                                <div class="relative">
                                    <img id="admin-profile-avatar" src="" alt="Avatar" 
                                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 hidden"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ddd\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'40\'%3EðŸ‘¤%3C/text%3E%3C/svg%3E';">
                                    <div id="admin-profile-avatar-placeholder" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center border-4 border-gray-200">
                                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Profile Picture</p>
                                    <p class="text-xs text-gray-500">Avatar is taken from your registered face</p>
                                    <p class="text-xs text-gray-400 mt-1">Register your face to set your avatar</p>
                                </div>
                            </div>
                            
                            <form id="admin-profile-form" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                                        <input type="text" name="firstName" id="admin-profile-firstName" required 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="First name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                                        <input type="text" name="lastName" id="admin-profile-lastName" required 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               placeholder="Last name">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                    <input type="email" name="email" id="admin-profile-email" required 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="your.email@example.com">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <input type="text" id="admin-profile-role" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" 
                                           readonly 
                                           disabled>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <input type="checkbox" id="admin-profile-change-password" class="mr-2"> Change Password
                                    </label>
                                    <input type="password" name="password" id="admin-profile-password" 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 hidden" 
                                           placeholder="Enter new password (minimum 6 characters)">
                                    <p class="text-xs text-gray-500 mt-1">Leave empty to keep current password</p>
                                </div>
                                
                                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                    <button type="button" id="admin-cancel-profile" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                        Cancel
                                    </button>
                                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                            
                            <div id="admin-profile-message" class="mt-4 hidden"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Add New User</h3>
            <form id="add-user-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select name="roleId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Role</option>
                        </select>
                    </div>
                    <div id="student-id-group" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                        <input type="text" name="studentId" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" 
                               placeholder="Auto-generated (STU01, STU02, ...)" 
                               readonly 
                               disabled>
                        <p class="text-xs text-gray-500 mt-1">Student ID will be automatically generated (STU01, STU02, ...)</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-add-user" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Edit User</h3>
            <form id="edit-user-form">
                <input type="hidden" name="userId" id="edit-user-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" name="firstName" id="edit-firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" name="lastName" id="edit-lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" name="email" id="edit-email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select name="roleId" id="edit-roleId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Role</option>
                        </select>
                    </div>
                    <div id="edit-student-id-group" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                        <input type="text" id="edit-studentId" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" 
                               readonly 
                               disabled>
                        <p class="text-xs text-gray-500 mt-1">Student ID cannot be changed</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <input type="checkbox" id="edit-change-password" class="mr-2"> Change Password
                        </label>
                        <input type="password" name="password" id="edit-password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 hidden" 
                               placeholder="Leave empty to keep current password">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-user" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Role Modal -->
    <div id="assign-role-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Assign Role</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Role</label>
                    <select id="assign-role-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="assign-role-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button type="button" id="assign-role-confirm" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Assign</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = `${window.location.origin}/api`;
        
        // Navigation
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section');
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all items
                    navItems.forEach(nav => nav.classList.remove('bg-gray-700'));
                    
                    // Add active class to clicked item
                    item.classList.add('bg-gray-700');
                    
                    // Hide all sections
                    sections.forEach(section => section.classList.add('hidden'));
                    
                    // Show target section
                    const target = item.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(target + '-section');
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                    
                    // Update page title
                    const pageTitle = document.getElementById('page-title');
                    const pageSubtitle = document.getElementById('page-subtitle');
                    
                    switch(target) {
                        case 'dashboard':
                            pageTitle.textContent = 'Admin Dashboard';
                            pageSubtitle.textContent = 'System overview and statistics';
                            loadDashboardStats();
                            break;
                        case 'profile':
                            pageTitle.textContent = 'My Profile';
                            pageSubtitle.textContent = 'Manage your personal information';
                            loadAdminProfileData();
                            break;
                        case 'users':
                            pageTitle.textContent = 'User Management';
                            pageSubtitle.textContent = 'Manage system users and permissions';
                            loadUsers();
                            break;
                        case 'roles':
                            pageTitle.textContent = 'Role Management';
                            pageSubtitle.textContent = 'Manage user roles and permissions';
                            loadRoles();
                            break;
                    }
                });
            });
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-teachers').textContent = data.totalTeachers || 0;
                    document.getElementById('total-students').textContent = data.totalStudents || 0;
                    document.getElementById('active-sessions').textContent = data.activeSessions || 0;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        let currentUserFilter = 'all';

        // Load users
        async function loadUsers(filter = currentUserFilter) {
            currentUserFilter = filter;
            setActiveUserFilterButton(filter);
            try {
                let endpoint = `${API_BASE_URL}/admin/users`;
                if (filter === 'teachers') endpoint = `${API_BASE_URL}/admin/teachers`;
                if (filter === 'students') endpoint = `${API_BASE_URL}/admin/students`;
                const response = await fetch(endpoint, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok) {
                    updateUsersTable(data.users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Update users table
        function updateUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-700">${user.firstName[0]}${user.lastName[0]}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.studentId ? '['+user.studentId+'] ' : ''}${user.firstName} ${user.lastName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeClass(user.roleName)}">${user.roleName}</span>
                        ${user.roleName === 'Unassigned' ? `<button class="ml-2 text-blue-600" onclick="openAssignRole('${user.userId}')">Assign</button>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editUser('${user.userId}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteUser('${user.userId}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Load roles
        async function loadRoles() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/roles`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok) {
                    updateRolesTable(data.roles);
                    updateRoleSelect(data.roles);
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        // Update roles table
        function updateRolesTable(roles) {
            const tbody = document.getElementById('roles-table-body');
            tbody.innerHTML = roles.map(role => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${role.roleName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${role.description || 'No description'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${role.userCount || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(role.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editRole('${role.roleId}', '${role.roleName.replace(/'/g, "&#39;")}','${(role.description || '').replace(/'/g, "&#39;")}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteRole('${role.roleId}', '${role.roleName.replace(/'/g, "&#39;")}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update role select in add user modal
        function updateRoleSelect(roles) {
            // Update role select in add user form
            const select = document.querySelector('select[name="roleId"]');
            select.innerHTML = '<option value="">Select Role</option>' + 
                roles.map(role => `<option value="${role.roleId}">${role.roleName}</option>`).join('');
            
            // Update role select in edit user form
            const editSelect = document.getElementById('edit-roleId');
            if (editSelect) {
                editSelect.innerHTML = '<option value="">Select Role</option>' + 
                    roles.map(role => `<option value="${role.roleId}">${role.roleName}</option>`).join('');
            }
        }

        // Get role badge class
        function getRoleBadgeClass(roleName) {
            switch(roleName) {
                case 'Admin': return 'bg-red-100 text-red-800';
                case 'Teacher': return 'bg-blue-100 text-blue-800';
                case 'Student': return 'bg-green-100 text-green-800';
                case 'Unassigned': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Assign Role flow using modal with dropdown
        function showAssignRoleModal(userId, roles) {
            const modal = document.getElementById('assign-role-modal');
            const select = document.getElementById('assign-role-select');
            modal.dataset.userId = userId;
            select.innerHTML = roles.map(r => `<option value="${r.roleId}">${r.roleName}</option>`).join('');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideAssignRoleModal() {
            const modal = document.getElementById('assign-role-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.dataset.userId = '';
        }

        async function openAssignRole(userId) {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/roles`, { credentials: 'include' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to load roles');
                const roles = data.roles || [];
                if (!roles.length) throw new Error('No roles available');
                showAssignRoleModal(userId, roles);
            } catch (e) {
                alert(e.message);
            }
        }

        // Modal functions
        function showAddUserModal() {
            document.getElementById('add-user-modal').classList.remove('hidden');
            document.getElementById('add-user-modal').classList.add('flex');
        }

        function hideAddUserModal() {
            document.getElementById('add-user-modal').classList.add('hidden');
            document.getElementById('add-user-modal').classList.remove('flex');
        }

        // Event listeners
        document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
        document.getElementById('cancel-add-user').addEventListener('click', hideAddUserModal);
        document.getElementById('assign-role-cancel').addEventListener('click', hideAssignRoleModal);
        document.getElementById('assign-role-confirm').addEventListener('click', async () => {
            const modal = document.getElementById('assign-role-modal');
            const userId = modal.dataset.userId;
            const roleId = document.getElementById('assign-role-select').value;
            if (!userId || !roleId) { alert('Please select a role'); return; }
            try {
                const assignRes = await fetch(`${API_BASE_URL}/admin/users/${userId}/assign-role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ roleId })
                });
                let messageText = 'Assign failed';
                if (assignRes.headers.get('content-type')?.includes('application/json')) {
                    const assignData = await assignRes.json();
                    if (!assignRes.ok) throw new Error(assignData.message || messageText);
                } else if (!assignRes.ok) {
                    const raw = await assignRes.text();
                    throw new Error(raw || messageText);
                }
                hideAssignRoleModal();
                loadUsers();
            } catch (e) { alert(e.message); }
        });
        // Filter buttons
        document.querySelectorAll('.user-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => loadUsers(btn.getAttribute('data-filter')));
        });
        function setActiveUserFilterButton(active) {
            document.querySelectorAll('.user-filter-btn').forEach(btn => {
                btn.classList.remove('ring-2','ring-offset-2');
                if (btn.getAttribute('data-filter') === active) {
                    btn.classList.add('ring-2','ring-offset-2');
                }
            });
        }
        // Show Student ID field if role is Student
        document.addEventListener('change', (e) => {
            if (e.target && e.target.name === 'roleId') {
                const selectedText = e.target.options[e.target.selectedIndex]?.text || '';
                const group = document.getElementById('student-id-group');
                if (selectedText.toLowerCase() === 'student') {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            }
        });
        
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            
            // Remove studentId from data (it's auto-generated, don't send it)
            delete userData.studentId;
            
            try {
                // Route to specific endpoint based on selected role label
                const roleSelect = document.querySelector('select[name="roleId"]');
                const selectedRoleText = roleSelect.options[roleSelect.selectedIndex]?.text || '';
                let endpoint = `${API_BASE_URL}/admin/users`;
                if (selectedRoleText.toLowerCase() === 'student') {
                    endpoint = `${API_BASE_URL}/admin/students`;
                } else if (selectedRoleText.toLowerCase() === 'teacher') {
                    endpoint = `${API_BASE_URL}/admin/teachers`;
                }
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    hideAddUserModal();
                    loadUsers();
                    e.target.reset();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                alert('Error adding user');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            loadDashboardStats();
            loadRoles();
        });

        // Edit User functions
        async function editUser(userId) {
            try {
                // Ensure roles are loaded first
                await loadRoles();
                
                // Load user details
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error: ' + (data.message || 'Failed to load user details'));
                    return;
                }
                
                const user = data.user;
                
                // Populate form
                document.getElementById('edit-user-id').value = user.userId;
                document.getElementById('edit-firstName').value = user.firstName;
                document.getElementById('edit-lastName').value = user.lastName;
                document.getElementById('edit-email').value = user.email;
                
                // Set role (after roles are loaded)
                const roleSelect = document.getElementById('edit-roleId');
                // Wait a bit for roles to be populated
                setTimeout(() => {
                    roleSelect.value = user.roleId || '';
                    
                    // Show/hide Student ID field based on role
                    const selectedText = roleSelect.options[roleSelect.selectedIndex]?.text || '';
                    const studentIdGroup = document.getElementById('edit-student-id-group');
                    if (selectedText.toLowerCase() === 'student' && user.studentId) {
                        studentIdGroup.classList.remove('hidden');
                        document.getElementById('edit-studentId').value = user.studentId;
                    } else {
                        studentIdGroup.classList.add('hidden');
                    }
                }, 100);
                
                // Show/hide Student ID field
                const studentIdGroup = document.getElementById('edit-student-id-group');
                const studentIdInput = document.getElementById('edit-studentId');
                if (user.studentId) {
                    studentIdInput.value = user.studentId;
                }
                
                // Reset password field
                document.getElementById('edit-change-password').checked = false;
                document.getElementById('edit-password').classList.add('hidden');
                document.getElementById('edit-password').value = '';
                document.getElementById('edit-password').required = false;
                
                // Show modal
                document.getElementById('edit-user-modal').classList.remove('hidden');
            } catch (err) {
                console.error('Error loading user:', err);
                alert('Error loading user details');
            }
        }

        // Cancel edit user
        document.getElementById('cancel-edit-user').addEventListener('click', () => {
            document.getElementById('edit-user-modal').classList.add('hidden');
            document.getElementById('edit-user-form').reset();
        });

        // Toggle password field
        document.getElementById('edit-change-password').addEventListener('change', (e) => {
            const passwordField = document.getElementById('edit-password');
            if (e.target.checked) {
                passwordField.classList.remove('hidden');
                passwordField.required = true;
            } else {
                passwordField.classList.add('hidden');
                passwordField.required = false;
                passwordField.value = '';
            }
        });

        // Handle edit user form submit
        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userId = formData.get('userId');
            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                roleId: formData.get('roleId')
            };
            
            // Only include password if change password is checked
            const changePassword = document.getElementById('edit-change-password').checked;
            if (changePassword) {
                const password = formData.get('password');
                if (password && password.length >= 6) {
                    userData.password = password;
                } else if (password) {
                    alert('Password must be at least 6 characters long');
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('edit-user-modal').classList.add('hidden');
                    loadUsers();
                    alert('User updated successfully!');
                } else {
                    alert('Error: ' + (data.message || 'Failed to update user'));
                }
            } catch (err) {
                console.error('Error updating user:', err);
                alert('Error updating user');
            }
        });

        // Show Student ID field in edit modal when role is Student
        document.getElementById('edit-roleId').addEventListener('change', (e) => {
            const selectedText = e.target.options[e.target.selectedIndex]?.text || '';
            const studentIdGroup = document.getElementById('edit-student-id-group');
            if (selectedText.toLowerCase() === 'student') {
                studentIdGroup.classList.remove('hidden');
            } else {
                studentIdGroup.classList.add('hidden');
            }
        });

        // Delete User function
        async function deleteUser(userId) {
            // Get user name for confirmation
            let userName = 'this user';
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, { credentials: 'include' });
                const data = await response.json();
                if (response.ok && data.user) {
                    userName = `${data.user.firstName} ${data.user.lastName}`;
                }
            } catch (err) {
                console.error('Error loading user for delete:', err);
            }
            
            if (!confirm(`Are you sure you want to delete user "${userName}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, { 
                    method: 'DELETE', 
                    credentials: 'include' 
                });
                const data = await response.json();
                
                if (response.ok) {
                    loadUsers();
                    alert('User deleted successfully!');
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete user'));
                }
            } catch (err) {
                console.error('Error deleting user:', err);
                alert('Error deleting user');
            }
        }

        // Role CRUD actions
        document.getElementById('add-role-btn').addEventListener('click', async () => {
            try {
                const name = prompt('Role name:');
                if (!name) return;
                const description = prompt('Description (optional):') || '';
                const res = await fetch(`${API_BASE_URL}/admin/roles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ roleName: name.trim(), description: description.trim() })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Create failed');
                loadRoles();
            } catch (e) { alert(e.message); }
        });

        function editRole(roleId, currentName, currentDesc) {
            (async () => {
                try {
                    const name = prompt('New role name:', currentName || '')
                    if (name === null) return;
                    const description = prompt('New description (optional):', currentDesc || '')
                    if (description === null) return;
                    const res = await fetch(`${API_BASE_URL}/admin/roles/${roleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ roleName: name.trim(), description: description.trim() })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Update failed');
                    loadRoles();
                } catch (e) { alert(e.message); }
            })();
        }

        function deleteRole(roleId, roleName) {
            (async () => {
                if (!confirm(`Delete role "${roleName}"?`)) return;
                try {
                    const res = await fetch(`${API_BASE_URL}/admin/roles/${roleId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Delete failed');
                    loadRoles();
                } catch (e) { alert(e.message); }
            })();
        }

        // Load admin profile data
        async function loadAdminProfileData() {
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile`, { credentials: 'include' });
                const data = await response.json();
                
                if (response.ok && data.user) {
                    const user = data.user;
                    
                    // Populate form
                    document.getElementById('admin-profile-firstName').value = user.firstName || '';
                    document.getElementById('admin-profile-lastName').value = user.lastName || '';
                    document.getElementById('admin-profile-email').value = user.email || '';
                    document.getElementById('admin-profile-role').value = user.roleName || 'Unassigned';
                    
                    // Set avatar
                    const avatarImg = document.getElementById('admin-profile-avatar');
                    const avatarPlaceholder = document.getElementById('admin-profile-avatar-placeholder');
                    if (user.avatar) {
                        // If avatar is base64, add data URL prefix if needed
                        let avatarSrc = user.avatar;
                        if (!avatarSrc.startsWith('data:image')) {
                            // Assume it's base64 encoded image, add prefix
                            avatarSrc = 'data:image/jpeg;base64,' + avatarSrc;
                        }
                        avatarImg.src = avatarSrc;
                        avatarImg.classList.remove('hidden');
                        avatarPlaceholder.classList.add('hidden');
                    } else {
                        avatarImg.classList.add('hidden');
                        avatarPlaceholder.classList.remove('hidden');
                    }
                    
                    // Reset password field
                    document.getElementById('admin-profile-change-password').checked = false;
                    document.getElementById('admin-profile-password').classList.add('hidden');
                    document.getElementById('admin-profile-password').value = '';
                    document.getElementById('admin-profile-password').required = false;
                    
                    // Hide message
                    document.getElementById('admin-profile-message').classList.add('hidden');
                } else {
                    showAdminProfileMessage('Error loading profile: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error('Error loading profile:', err);
                showAdminProfileMessage('Error loading profile information', 'error');
            }
        }

        // Toggle password field
        document.getElementById('admin-profile-change-password')?.addEventListener('change', (e) => {
            const passwordField = document.getElementById('admin-profile-password');
            if (e.target.checked) {
                passwordField.classList.remove('hidden');
                passwordField.required = true;
            } else {
                passwordField.classList.add('hidden');
                passwordField.required = false;
                passwordField.value = '';
            }
        });

        // Handle admin profile form submit
        document.getElementById('admin-profile-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const profileData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email')
            };
            
            // Only include password if change password is checked
            const changePassword = document.getElementById('admin-profile-change-password').checked;
            if (changePassword) {
                const password = formData.get('password');
                if (password && password.length >= 6) {
                    profileData.password = password;
                } else if (password) {
                    showAdminProfileMessage('Password must be at least 6 characters long', 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAdminProfileMessage('Profile updated successfully!', 'success');
                    // Update header name
                    const userNameSpan = document.getElementById('user-name');
                    if (userNameSpan) {
                        userNameSpan.textContent = `${profileData.firstName} ${profileData.lastName}`;
                    }
                    // Reload profile data
                    setTimeout(() => loadAdminProfileData(), 1000);
                } else {
                    showAdminProfileMessage('Error: ' + (data.message || 'Failed to update profile'), 'error');
                }
            } catch (err) {
                console.error('Error updating profile:', err);
                showAdminProfileMessage('Error updating profile', 'error');
            }
        });

        // Cancel admin profile changes
        document.getElementById('admin-cancel-profile')?.addEventListener('click', () => {
            loadAdminProfileData();
        });

        // Show admin profile message
        function showAdminProfileMessage(message, type) {
            const messageDiv = document.getElementById('admin-profile-message');
            if (!messageDiv) return;
            
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                messageDiv.className = 'mt-4 p-4 bg-green-100 text-green-700 border border-green-400 rounded-lg';
            } else {
                messageDiv.className = 'mt-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg';
            }
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
